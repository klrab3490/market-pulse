name: CI - Backend & Frontend

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    backend:
        name: 🔧 Backend (FastAPI)
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: src

        env:
            LLM_API: ${{ secrets.LLM_API }}
            NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
            TWELVE_DATA_API_KEY: ${{ secrets.TWELVE_DATA_API_KEY }}

        steps:
            - name: 📥 Checkout code
              uses: actions/checkout@v4

            - name: 🐍 Set up Python
              uses: actions/setup-python@v5
              with:
                python-version: "3.10"
                cache: pip

            - name: 📦 Install backend dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt
                pip install flake8 pytest

            - name: 🔍 Lint backend
              run: |
                flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
                flake8 . --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics

            - name: ✅ Run backend tests
              run: pytest
              
    frontend:
        name: 🌐 Frontend (Next.js)

        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: frontend

        strategy:
            matrix:
                node-version: [18.x, 20.x, 22.x]

        steps:
            - name: 📥 Checkout code
              uses: actions/checkout@v4

            - name: 🟢 Set up Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                node-version: ${{ matrix.node-version }}
                cache: npm
                cache-dependency-path: frontend/package-lock.json

            - name: 📦 Install frontend dependencies
              run: npm install

            - name: ✨ Lint frontend
              run: npm run lint

            - name: ✅ Run Jest tests
              run: npm run test -- --ci --watchAll=false

            - name: 🔨 Build Next.js app
              run: npm run build
