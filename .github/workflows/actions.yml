name: Launch API Endpoint

on:
    push:
    pull_request:

jobs:
    run:
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: src

        env:
            LLM_API: ${{ secrets.LLM_API }}
            NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
            TWELVE_DATA_API_KEY: ${{ secrets.TWELVE_DATA_API_KEY }}

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ Set up Python
              uses: actions/setup-python@v4
              with:
                python-version: '3.11'
                cache: 'pip'

            - name: ğŸ“¦ Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt

            - name: ğŸ§ª Lint with flake8
              run: |
                flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
                flake8 . --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics

            - name: ğŸ§ª Run tests
              run: |
                pytest

            - name: ğŸš€ Run API (dev mode)
              if: github.event_name == 'push'
              run: |
                uvicorn main:app --host 0.0.0.0 --port 8000 --reload &
                sleep 5
                curl http://0.0.0.0:8000 || curl http://localhost:8000
                echo "API running at http://$(hostname -I | awk '{print $1}'):8000"